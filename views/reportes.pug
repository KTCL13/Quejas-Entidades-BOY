extends layout

block content
  .container.mt-4
    h2.mb-4 Reporte de Quejas por Entidad
    table.table.table-bordered#tablaReporte
      thead.table-secondary
        tr
          th Entidad
          th Total Quejas
      tbody
        tr
          td(colspan="2") Cargando...

  script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js")
  script.
    document.addEventListener('DOMContentLoaded', () => {
      cargarReporteQuejas();
    });

    async function cargarReporteQuejas() {
      const tbody = document.querySelector('#tablaReporte tbody');
      if (!tbody) return;

      tbody.innerHTML = '<tr><td colspan="3">Cargando...</td></tr>';

      try {
        const resp = await fetch('/api/quejas/quejas-por-entidad');
        if (!resp.ok) throw new Error('Error HTTP ' + resp.status);
        const data = await resp.json();

        if (!Array.isArray(data) || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3">No hay quejas registradas</td></tr>';
          return;
        }

        tbody.innerHTML = '';
        data.forEach(row => {
          const nombre = escapeHtml(row.nombre_entidad || 'Sin nombre');
          const total = Number(row.total_quejas || 0);
          let ids = '';
          if (Array.isArray(row.id_entidad) && row.id_entidad.length) {
            ids = row.id_entidad.join(', ');
          } else if (row.id_entidad) {
            ids = String(row.id_entidad);
          } else {
            ids = '';
          }

          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${nombre}</td><td class="numeric">${total.toLocaleString()}</td>`;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error('Error al cargar reporte:', err);
        tbody.innerHTML = '<tr><td colspan="3">Error al cargar los datos</td></tr>';
      }
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"'`=\/]/g, function (s) {
        return ({
          '&':'&amp;',
          '<':'&lt;',
          '>':'&gt;',
          '"':'&quot;',
          "'":'&#39;',
          '/':'&#x2F;',
          '`':'&#x60;',
          '=':'&#x3D;'
        }[s]);
      });
    }