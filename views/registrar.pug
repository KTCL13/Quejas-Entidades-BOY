extends layout

block content
  h1 Registrar Queja

  form(action='/api/complaints', method='POST', id='formQueja', style='max-width:600px;margin:auto;')
    div(style='margin-bottom:20px;')
      label(for='id_entidad', style='display:block;margin-bottom:5px;') Entidad Pública
      select(name='id_entidad', id='id_entidad', required, style='width:100%;padding:8px;')
        option(value='') Seleccione una entidad...
        each entidad in entidades
          option(value=entidad.id)= entidad.name

    div(style='margin-bottom:20px;')
      label(for='texto', style='display:block;margin-bottom:5px;') Queja
      textarea(name='texto', id='texto', rows='6', required, placeholder='Escriba su queja aquí. (10-2000 caracteres)', style='width:100%;padding:8px;resize:vertical;')

    button(type='submit', id='btnEnviar', style='padding:8px 16px;', color: green, background: white, border:2px) Enviar queja

  div#mensaje(style='margin-top:20px;padding:10px;border-radius:4px;display:none;text-align:center;')

  script.
    const form = document.getElementById('formQueja');
    const entidadSelect = document.getElementById('id_entidad');
    const mensajeDiv = document.getElementById('mensaje');
    const btnEnviar = document.getElementById('btnEnviar');

    function mostrarMensaje(tipo, texto) {
      mensajeDiv.style.display = 'block';
      mensajeDiv.style.color = tipo === 'error' ? '#dc3545' : '#28a745';
      mensajeDiv.style.backgroundColor = tipo === 'error' ? '#f8d7da' : '#d4edda';
      mensajeDiv.style.border = tipo === 'error' ? '1px solid #f5c6cb' : '1px solid #c3e6cb';
      mensajeDiv.textContent = texto;

      // Auto-hide after 5 seconds
      setTimeout(() => {
        mensajeDiv.style.display = 'none';
      }, 5000);
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id_entidad_val = entidadSelect.value;
      const description = document.getElementById('texto').value;

      if (!id_entidad_val) {
        mostrarMensaje('error', 'Debe seleccionar una entidad.');
        return;
      }

      btnEnviar.disabled = true;
      
      try {
        const res = await fetch('/api/complaints', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            entity_id: Number(id_entidad_val), 
            description 
          })
        });

        const data = await res.json();

        if (!res.ok) {
          mostrarMensaje('error', data.error || 'Error al registrar la queja');
        } else {
          mostrarMensaje('success', 'Queja registrada exitosamente');
          form.reset();
        }
      } catch (err) {
        mostrarMensaje('error', 'Error de servidor: ' + err.message);
      } finally {
        btnEnviar.disabled = false;
      }
    });