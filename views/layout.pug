doctype html
html
  head
    title Quejas Entidades Públicas de Boyacá
    meta(charset="utf-8")
    meta(name="viewport" content="width=device-width, initial-scale=1")
    link(rel="stylesheet", href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css")
    link(rel="stylesheet", href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css")
    script(src="https://www.google.com/recaptcha/api.js?render=6LeBKKkrAAAAAObCxLb511gIotGRecWMZZOEZhRg")

  body
   
    nav.navbar.navbar-expand-lg.navbar-light.bg-light.shadow-sm.border-bottom
      .container
        a.navbar-brand.fw-semibold.text-primary(href="#") 
          i.bi.bi-building.me-2
          | Sistema de Quejas - Boyacá

        button.navbar-toggler(type="button", data-bs-toggle="collapse", data-bs-target="#navbarNav")
          span.navbar-toggler-icon

        #navbarNav.collapse.navbar-collapse
          ul.navbar-nav.ms-auto
            li.nav-item
              a.nav-link(href='/' class=(activePage === 'lista' ? 'active fw-semibold text-dark' : '')) 
                i.bi.bi-list-ul.me-1
                | Lista de Quejas
            li.nav-item
              a.nav-link(href='/api/complaints/registrar' class=(activePage === 'registrar' ? 'active fw-semibold text-dark' : ''))
                i.bi.bi-pencil-square.me-1
                | Registrar Queja
            li.nav-item
              a.nav-link#linkReporte(href='/api/reports' class=(activePage === 'reportes' ? 'active fw-semibold text-dark' : ''))
                i.bi.bi-bar-chart.me-1
                | Reportes

          
          ul.navbar-nav.ms-3
            li.nav-item.dropdown
              if user
                a.nav-link.dropdown-toggle.text-dark.fw-semibold(href='#', id='userMenu', role='button', data-bs-toggle='dropdown')
                  i.bi.bi-person-circle.me-1
                  | Usuario activo
                ul.dropdown-menu.dropdown-menu-end(aria-labelledby='userMenu')
                  li.text-center.text-muted.small.px-3.py-1
                    | #{user.nombre || user.email}
                  li
                    hr.dropdown-divider
                  li
                    a.dropdown-item.text-danger(href='/logout')
                      i.bi.bi-box-arrow-right.me-2
                      | Cerrar sesión
              else
                a.btn.btn-outline-primary.fw-semibold(href='/login')
                  i.bi.bi-box-arrow-in-right.me-1
                  | Iniciar sesión

    
    .container.mt-4
      block content

      script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js")
      script.
        document.addEventListener('DOMContentLoaded', () => {
        // Manejo del enlace de reportes (ya existente)
        const linkReporte = document.getElementById('linkReporte');
        if (linkReporte) {
          linkReporte.addEventListener('click', async (e) => {
            try {
              await fetch('/api/reports/ver');
              console.log("Correo enviado automáticamente al entrar en reportes");
            } catch (err) {
              console.error("Error al enviar correo automático:", err);
            }
          });
        }
        });

        // 👇 Nuevo código para mostrar sesión y manejar logout
        const navContainer = document.querySelector('.navbar-nav.ms-3');
        const storedEmail = localStorage.getItem('userEmail');

        if (storedEmail) {
          // Mostrar usuario y botón de cierre de sesión
          navContainer.innerHTML = `
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle text-dark fw-semibold" href="#" id="userMenu" role="button" data-bs-toggle="dropdown">
                <i class="bi bi-person-circle me-1"></i> ${storedEmail}
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
                <li class="text-center text-muted small px-3 py-1">${storedEmail}</li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-danger" id="logoutBtn" href="#">
                  <i class="bi bi-box-arrow-right me-2"></i> Cerrar sesión
                </a></li>
              </ul>
            </li>`;

          // Escuchar clic en "Cerrar sesión"
          document.getElementById('logoutBtn').addEventListener('click', async (e) => {
            e.preventDefault();

            try {
              const response = await fetch('/api/logout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: storedEmail }),
              });

              if (response.ok) {
                console.log("Sesión cerrada correctamente");
                localStorage.removeItem('userEmail'); 
                window.location.href = '/'; 
              } else {
                console.error("Error al cerrar sesión:", await response.text());
                alert("Error al cerrar sesión");
              }
            } catch (err) {
              console.error("Error en la solicitud de logout:", err);
              alert("No se pudo cerrar la sesión");
            }
          });
        }